<div class="quiz-results-container">
  @if (loading()) {
    <div class="center-state">
      <mat-spinner diameter="48"></mat-spinner>
    </div>
  } @else {
    <!-- Score Section -->
    <div class="score-section">
      <div class="stars-row">
        @for (filled of starsArray(); track $index) {
          <mat-icon class="star-icon" [class.filled]="filled" [class.empty]="!filled">
            {{ filled ? 'star' : 'star_border' }}
          </mat-icon>
        }
      </div>

      <div class="score-value">{{ score() }}</div>
      <div class="score-max">/ {{ maxScore() }} ({{ percentage() }}%)</div>

      @if (quiz()) {
        <h2 class="quiz-title">{{ quiz()!.title }}</h2>
      }
    </div>

    <!-- Estimated rank (before publish, authenticated only) -->
    @if (isAuthenticated() && !published()) {
      <div class="estimated-rank">
        <mat-icon>emoji_events</mat-icon>
        <span>{{ 'quiz.results.estimatedRank' | translate:{ rank: estimatedRank() } }}</span>
      </div>
    }

    <!-- Publish button (authenticated, not yet published) -->
    @if (isAuthenticated() && !published()) {
      <div class="publish-section">
        <button
          mat-raised-button
          class="publish-btn"
          (click)="publishScore()"
          [disabled]="publishing()"
        >
          @if (publishing()) {
            <mat-spinner diameter="20"></mat-spinner>
            {{ 'quiz.results.publishing' | translate }}
          } @else {
            <ng-container>
              <mat-icon>publish</mat-icon>
              {{ 'quiz.results.publish' | translate }}
            </ng-container>
          }
        </button>
      </div>
    }

    <!-- Publish success -->
    @if (published() && publishedRank()) {
      <div class="publish-success">
        <mat-icon>check_circle</mat-icon>
        <span>{{ 'quiz.results.published' | translate:{ rank: publishedRank() } }}</span>
      </div>
    }

    <!-- Guest warning -->
    @if (isGuest()) {
      <div class="guest-banner">
        <mat-icon>info</mat-icon>
        <div class="guest-banner-text">
          <p>{{ 'quiz.results.guestWarning' | translate }}</p>
          <button mat-raised-button color="primary" (click)="goToLogin()">
            {{ 'quiz.results.loginToSave' | translate }}
          </button>
        </div>
      </div>
    }

    <!-- Leaderboard -->
    @if (displayLeaderboard().length > 0) {
      <div class="leaderboard-section">
        <h3>
          <mat-icon>leaderboard</mat-icon>
          {{ 'quiz.results.leaderboard' | translate }}
        </h3>
        <div class="leaderboard-list">
          @for (entry of displayLeaderboard(); track entry.id; let i = $index) {
            <div
              class="leaderboard-row"
              [class.top-3]="i < 3"
              [class.current-user]="isCurrentUser(entry)"
            >
              <span class="rank" [class.rank-1]="i === 0" [class.rank-2]="i === 1" [class.rank-3]="i === 2">{{ i + 1 }}</span>
              <app-user-avatar
                [username]="entry.username ?? '?'"
                [avatarStyle]="entry.avatarStyle ?? 'initials'"
                [avatarSeed]="entry.avatarSeed ?? entry.username ?? '?'"
                [avatarBgColor]="entry.avatarBgColor ?? '0d7c51'"
                size="32px"
              />
              <span class="player-name">{{ entry.username ?? '?' }}</span>
              <span class="player-score">{{ entry.score }}</span>
              <div class="player-stars">
                @for (s of [0,1,2]; track s) {
                  <mat-icon class="mini-star" [class.filled]="s < entry.stars">
                    {{ s < entry.stars ? 'star' : 'star_border' }}
                  </mat-icon>
                }
              </div>
            </div>
          }

          <!-- User outside visible list: separator + their row -->
          @if (published() && publishedRank() && !userInDisplayedList() && publishedEntry()) {
            <div class="leaderboard-separator">
              <span>...</span>
            </div>
            <div class="leaderboard-row current-user">
              <span class="rank">{{ publishedRank() }}</span>
              <app-user-avatar
                [username]="publishedEntry()!.username ?? '?'"
                [avatarStyle]="publishedEntry()!.avatarStyle ?? 'initials'"
                [avatarSeed]="publishedEntry()!.avatarSeed ?? publishedEntry()!.username ?? '?'"
                [avatarBgColor]="publishedEntry()!.avatarBgColor ?? '0d7c51'"
                size="32px"
              />
              <span class="player-name">{{ publishedEntry()!.username ?? '?' }}</span>
              <span class="player-score">{{ publishedEntry()!.score }}</span>
              <div class="player-stars">
                @for (s of [0,1,2]; track s) {
                  <mat-icon class="mini-star" [class.filled]="s < publishedEntry()!.stars">
                    {{ s < publishedEntry()!.stars ? 'star' : 'star_border' }}
                  </mat-icon>
                }
              </div>
            </div>
          }
        </div>

        <!-- Show full leaderboard button -->
        @if (hasMoreEntries() && !showFullLeaderboard()) {
          <button
            mat-button
            class="show-all-btn"
            (click)="loadFullLeaderboard()"
            [disabled]="loadingFull()"
          >
            @if (loadingFull()) {
              <mat-spinner diameter="16"></mat-spinner>
            } @else {
              <mat-icon>expand_more</mat-icon>
            }
            {{ 'quiz.results.showAll' | translate }}
          </button>
        }
      </div>
    }

    <!-- Actions -->
    <div class="actions-section">
      <button mat-raised-button (click)="goToReview()">
        <mat-icon>visibility</mat-icon>
        {{ 'quiz.results.review' | translate }}
      </button>
      <button mat-raised-button color="primary" (click)="replay()">
        <mat-icon>replay</mat-icon>
        {{ 'quiz.results.replay' | translate }}
      </button>
      <button mat-button (click)="goToQuizList()">
        {{ 'quiz.results.backToList' | translate }}
      </button>
    </div>
  }
</div>
