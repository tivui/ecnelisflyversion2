<mat-sidenav-container class="sidenav-container">
  <!-- Sidenav Menu -->
  <mat-sidenav
    #sidenav
    mode="over"
    [position]="isMobilePortrait() ? 'end' : 'start'"
    [opened]="sidenavOpened()"
    (closedStart)="closeSidenav()"
    class="main-sidenav"
  >
    <app-sidenav-menu
      [isOpen]="sidenavOpened()"
      [isDark]="isDark()"
      [currentLanguage]="selectedLang()"
      [languages]="languages"
      (closed)="closeSidenav()"
      (themeToggled)="toggleDarkMode()"
      (languageChanged)="changeLang($event)"
    />
  </mat-sidenav>

  <!-- Main Content -->
  <mat-sidenav-content>
    <mat-toolbar color="primary">
      <!-- Hamburger menu button (desktop only — moved to bottom nav on mobile) -->
      <button
        class="menu-btn desktop-only-toolbar"
        mat-icon-button
        (click)="toggleSidenav()"
        aria-label="Toggle menu"
      >
        <mat-icon>menu</mat-icon>
      </button>

      <a class="logo-link" routerLink="/home">
        <img
          src="img/logos/logo_blue_orange_left.png"
          alt="Ecnelis Fly"
          class="toolbar-logo"
          [class.hide-desktop-home]="isHomePage() || isCategoryMapPage()"
          [class.hide-login]="isLoginPage()"
        />
        <span class="app-title">Ecnelis FLY</span>
      </a>

      <!-- Bouton plein écran (desktop only) -->
      <button
        class="fullscreen-btn desktop-only-toolbar"
        mat-icon-button
        (click)="toggleFullscreen()"
        [matTooltip]="
          (isFullscreen() ? 'toolbar.fullscreen.exit' : 'toolbar.fullscreen.enter')
            | translate
        "
      >
        <mat-icon>{{ isFullscreen() ? "fullscreen_exit" : "fullscreen" }}</mat-icon>
      </button>
      <span class="spacer"></span>

      <!-- Admin settings wheel (desktop only) -->
      @if (authenticator.user && isAdmin()) {
        <button
          class="desktop-only-toolbar"
          mat-icon-button
          [matMenuTriggerFor]="adminMenu"
          matTooltip="Settings"
        >
          <mat-icon>settings</mat-icon>
        </button>

        <mat-menu #adminMenu="matMenu">
          <button mat-menu-item [routerLink]="'/admin/dashboard'">
            <mat-icon>dashboard</mat-icon>
            {{ "toolbar.admin.dashboard" | translate }}
          </button>
          <button mat-menu-item [routerLink]="'/admin/database'">
            <mat-icon>storage</mat-icon>
            {{ "toolbar.admin.manage-database" | translate }}
          </button>
        </mat-menu>
      }

      <!-- Lang selector -->
      <mat-menu #langMenu="matMenu">
        @for (l of languages; track l) {
          <button mat-menu-item (click)="changeLang(l)">
            {{ l.toUpperCase() }}
          </button>
        }
      </mat-menu>

      <button class="desktop-only-toolbar" mat-button [matMenuTriggerFor]="langMenu">
        {{ selectedLang() | uppercase }}
        <mat-icon>arrow_drop_down</mat-icon>
      </button>

      <!-- Dark mode toggle with icons (desktop only — moved to sidebar on mobile) -->
      <button
        class="desktop-only-toolbar"
        mat-icon-button
        (click)="toggleDarkMode()"
        [matTooltip]="(isDark() ? 'toolbar.light' : 'toolbar.dark') | translate"
      >
        <mat-icon>{{ isDark() ? "dark_mode" : "light_mode" }}</mat-icon>
      </button>

      <!-- Auth -->
      @if (authenticator.user) {
        <!-- Avatar button -->
        <button mat-icon-button class="avatar-btn" [matMenuTriggerFor]="userMenu">
          @if (appUser()) {
            <app-user-avatar
              [username]="appUser()!.username"
              [avatarStyle]="appUser()!.avatarStyle"
              [avatarSeed]="appUser()!.avatarSeed"
              [avatarBgColor]="appUser()!.avatarBgColor"
              [avatarOptions]="appUser()!.avatarOptions"
              size="32px"
            />
          } @else {
            <mat-icon>account_circle</mat-icon>
          }
        </button>

        <!-- User menu -->
        <mat-menu #userMenu="matMenu">
          <button mat-menu-item (click)="goToAccount()">
            <mat-icon>manage_accounts</mat-icon>
            {{ "toolbar.account" | translate }}
          </button>
          <button mat-menu-item [routerLink]="'/dashboard'">
            <mat-icon>library_music</mat-icon>
            {{ "toolbar.dashboard" | translate }}
          </button>
          <button mat-menu-item (click)="goToNewSound()">
            <mat-icon>add_location</mat-icon>
            {{ "toolbar.new-sound" | translate }}
          </button>
          <button mat-menu-item (click)="authenticator.signOut()">
            <mat-icon>logout</mat-icon>
            {{ "toolbar.logout" | translate }}
          </button>
        </mat-menu>
      } @else {
        <button mat-button color="primary" [routerLink]="'/login'">
          <mat-icon>login</mat-icon>
          {{ "toolbar.login" | translate }}
        </button>
      }
    </mat-toolbar>

    <router-outlet></router-outlet>
  </mat-sidenav-content>
</mat-sidenav-container>

<!-- Bottom navigation bar (mobile portrait only) — outside sidenav-container to avoid overflow:hidden clipping -->
@if (isMobilePortrait() && !sidenavOpened()) {
  <nav class="bottom-nav">
    <a class="bottom-nav-item" [class.active]="activeRoute().startsWith('/home')" routerLink="/home">
      <mat-icon>home</mat-icon>
      <span>{{ 'bottomNav.home' | translate }}</span>
    </a>
    <button class="bottom-nav-item" [class.active]="(activeRoute() === '/mapfly' || activeRoute().startsWith('/mapfly?')) && !activeRoute().includes('featuredMode')" (click)="goToMap()">
      <mat-icon>public</mat-icon>
      <span>{{ 'bottomNav.map' | translate }}</span>
    </button>
    <button class="bottom-nav-item" [class.active]="activeRoute().includes('featuredMode')" [class.disabled]="!bottomNavFeatured()" (click)="goToFeaturedFromBottomNav()">
      <mat-icon>headphones</mat-icon>
      <span>{{ 'bottomNav.featured' | translate }}</span>
    </button>
    <button class="bottom-nav-item" (click)="toggleSidenav()">
      <mat-icon>menu</mat-icon>
      <span>{{ 'bottomNav.menu' | translate }}</span>
    </button>
  </nav>
}

<!-- PWA install banner -->
<app-pwa-install-banner></app-pwa-install-banner>

<!-- Welcome overlay on login -->
@if (welcomeVisible()) {
  <div class="welcome-overlay" [class.fade-out]="welcomeFadingOut()">
    <div class="welcome-card">
      <img src="/img/logos/logo_blue_orange_left_round.png" alt="" class="welcome-logo" />
      <p class="welcome-greeting">{{ 'home.welcomeGreeting' | translate }}</p>
      <div class="welcome-divider"></div>
      <h1 class="welcome-name">{{ welcomeUsername() }}</h1>
      <p class="welcome-subtitle">{{ 'home.welcomeSubtitle' | translate }}</p>
    </div>
  </div>
}

<!-- Goodbye overlay on logout -->
@if (goodbyeVisible()) {
  <div class="welcome-overlay goodbye-overlay" [class.fade-out]="goodbyeFadingOut()">
    <div class="welcome-card goodbye-card">
      <img src="/img/logos/logo_blue_orange_left_round.png" alt="" class="welcome-logo" />
      <p class="welcome-greeting">{{ 'home.goodbyeGreeting' | translate }}</p>
      <div class="welcome-divider"></div>
      <h1 class="welcome-name">{{ goodbyeUsername() }}</h1>
      <p class="welcome-subtitle">{{ 'home.goodbyeSubtitle' | translate }}</p>
    </div>
  </div>
}
